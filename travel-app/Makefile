# ============================================================
# é’ç”˜è¥¿è—è‡ªé©¾è¡Œç¨‹ - Makefile
# ============================================================

PORT := 3000
URL := http://localhost:$(PORT)
PID_FILE := .server.pid

# é»˜è®¤ç›®æ ‡
.PHONY: run
run: start
	@echo "âœ… æœåŠ¡å™¨å·²å¯åŠ¨: $(URL)"
	@echo "   æŒ‰ Ctrl+C åœæ­¢æœåŠ¡å™¨"

# å¯åŠ¨æœåŠ¡å™¨å¹¶æ‰“å¼€ç½‘é¡µ
.PHONY: start
start:
	@if lsof -ti:$(PORT) > /dev/null 2>&1; then \
		echo "âš ï¸  ç«¯å£ $(PORT) å·²è¢«å ç”¨ï¼ŒæœåŠ¡å™¨å¯èƒ½å·²åœ¨è¿è¡Œ"; \
		echo "   è®¿é—® $(URL) æŸ¥çœ‹"; \
	else \
		echo "ğŸš€ å¯åŠ¨æœåŠ¡å™¨..."; \
		cd server && node server.js & \
		echo $$! > $(PID_FILE); \
		sleep 2; \
		open $(URL); \
	fi

# åœæ­¢æœåŠ¡å™¨
.PHONY: stop
stop:
	@if [ -f $(PID_FILE) ]; then \
		PID=$$(cat $(PID_FILE)); \
		if kill $$PID 2>/dev/null; then \
			echo "ğŸ›‘ æœåŠ¡å™¨å·²åœæ­¢"; \
		else \
			echo "âš ï¸  æ— æ³•åœæ­¢è¿›ç¨‹ $$PID"; \
		fi; \
		rm -f $(PID_FILE); \
	elif lsof -ti:$(PORT) > /dev/null 2>&1; then \
		kill $$(lsof -ti:$(PORT)) 2>/dev/null && echo "ğŸ›‘ æœåŠ¡å™¨å·²åœæ­¢" || echo "âš ï¸  åœæ­¢å¤±è´¥"; \
	else \
		echo "â„¹ï¸  æœåŠ¡å™¨æœªè¿è¡Œ"; \
	fi

# é‡å¯æœåŠ¡å™¨
.PHONY: restart
restart: stop
	@echo "ğŸ”„ é‡å¯æœåŠ¡å™¨..."
	@sleep 1
	$(MAKE) start

# æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
.PHONY: status
status:
	@if lsof -ti:$(PORT) > /dev/null 2>&1; then \
		echo "âœ… æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ"; \
		echo "   è®¿é—® $(URL)"; \
	else \
		echo "âŒ æœåŠ¡å™¨æœªè¿è¡Œ"; \
		echo "   è¿è¡Œ make run å¯åŠ¨"; \
	fi

# æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼ˆæœ€å 20 è¡Œï¼‰
.PHONY: logs
logs:
	@if lsof -ti:$(PORT) > /dev/null 2>&1; then \
		echo "ğŸ“‹ æœåŠ¡å™¨æ—¥å¿— (Ctrl+C é€€å‡º):"; \
		tail -f /dev/null 2>/dev/null || echo "(æ—¥å¿—éœ€åœ¨ç»ˆç«¯æŸ¥çœ‹)"; \
	else \
		echo "âŒ æœåŠ¡å™¨æœªè¿è¡Œ"; \
	fi

# æµ‹è¯• API ç«¯ç‚¹
.PHONY: test-api
test-api:
	@echo "ğŸ§ª æµ‹è¯• API..."
	@echo ""
	@echo "1. GET /api/trip-data:"
	@curl -s $(URL)/api/trip-data | head -c 200
	@echo ""
	@echo ""
	@echo "2. POST /api/expenses/D1 (æ·»åŠ æµ‹è¯•å¼€é”€):"
	@curl -s -X POST $(URL)/api/expenses/D1 \
		-H "Content-Type: application/json" \
		-d '{"item":"æµ‹è¯•","amount":100}' | head -c 100
	@echo ""

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
.PHONY: help
help:
	@echo "ğŸ“‹ é’ç”˜è¥¿è—è‡ªé©¾è¡Œç¨‹ - Makefile"
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  make run      å¯åŠ¨æœåŠ¡å™¨å¹¶æ‰“å¼€ç½‘é¡µ"
	@echo "  make start    ä»…å¯åŠ¨æœåŠ¡å™¨ï¼ˆä¸æ‰“å¼€ç½‘é¡µï¼‰"
	@echo "  make stop     åœæ­¢æœåŠ¡å™¨"
	@echo "  make restart  é‡å¯æœåŠ¡å™¨"
	@echo "  make status   æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€"
	@echo "  make test-api æµ‹è¯• API ç«¯ç‚¹"
	@echo "  make help     æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""
	@echo "è®¿é—® $(URL) æŸ¥çœ‹åº”ç”¨"
